#  -*- Autoconf -*-

AT_SETUP([database check for normalization])

# the included database is valid except for all paths being "./" prefixed,
# hence the database doesn't have correctly normalised revisions.

# for future reference, it was created with a modified monotone binary,
# paths.cc was modified. Also, the 'add_dir "."' was added to MT/work by hand.

#old_revision []
#
#add_dir ""
#
#add_dir "."
#
#add_file "./file"


MONOTONE_SETUP
NEED_UNGZB64

AT_DATA(bad.db.gz.b64,[
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
====
])
UNGZB64(bad.db.gz.b64, bad.db)

AT_CHECK(MONOTONE db migrate -d bad.db, [0], [ignore], [ignore])

AT_CHECK(MONOTONE db check -d bad.db, [1], [ignore], [stderr])

AT_CHECK(grep 'revisions not parseable' stderr, [], [ignore], [ignore])

AT_CLEANUP
