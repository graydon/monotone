#  -*- Autoconf -*-

AT_SETUP([rename files into a directory])

MONOTONE_SETUP

ADD_FILE(gnat, [gnat
])
ADD_FILE(mosquito, [mosquito
])
ADD_FILE(termite, [termite
])
ADD_FILE(ant, [ant
])

# will force foo/, bar/ and foo/gnat/ to be created
AT_CHECK(mkdir foo bar foo/gnat)
ADD_FILE(foo/dummy, [... ... ...
])
ADD_FILE(bar/dummy, [a b c
])
ADD_FILE(foo/gnat/dummmy, [la la la
])

COMMIT(testbranch)

# checkout in a clean dir and cd there
m4_define([REN_CHECKOUT], [
AT_CHECK(rm -fr $_ROOT_DIR/checkout, [], [ignore], [ignore])
AT_CHECK(MONOTONE checkout -b testbranch $_ROOT_DIR/checkout, [0], [ignore], [ignore])
])

REN_CHECKOUT

# basics
AT_CHECK(cd checkout && MONOTONE rename ant foo, [0], [ignore], [ignore])
AT_CHECK(cd checkout && MONOTONE rename mosquito termite foo, [0], [ignore], [ignore])

REN_CHECKOUT

# with --execute
AT_CHECK(cd checkout && MONOTONE --execute rename ant foo, [0], [ignore], [ignore])
AT_CHECK(cd checkout && MONOTONE --execute rename mosquito termite foo, [0], [ignore], [ignore])
AT_CHECK(cd checkout && test -e foo/ant -a -e foo/mosquito -a -e foo/termite)
AT_CHECK(cd checkout && test ! -e ant -a ! -e mosquito -a ! -e termite)

# to root
AT_CHECK(cd checkout && MONOTONE --execute rename foo/ant ., [0], [ignore], [ignore])
AT_CHECK(cd checkout && MONOTONE rename foo/termite ., [0], [ignore], [ignore])
AT_CHECK(cd checkout && test -e ant -a -e foo/termite -a ! -e foo/ant -a ! -e termite)

REN_CHECKOUT

# conflicts
AT_CHECK(cd checkout && MONOTONE rename gnat foo, [1], [ignore], [ignore])
AT_CHECK(cd checkout && MONOTONE rename gnat termite foo, [1], [ignore], [ignore])
AT_CHECK(cd checkout && MONOTONE rename termite foo, [0], [ignore], [ignore])

AT_CHECK(cd checkout && MONOTONE rename mosquito foo/ant, [0], [ignore], [ignore])
AT_CHECK(cd checkout && MONOTONE rename ant foo, [1], [ignore], [ignore])

REN_CHECKOUT

AT_CHECK(cd checkout && MONOTONE --execute rename gnat foo, [1], [ignore], [ignore])
AT_CHECK(cd checkout && MONOTONE --execute rename gnat termite foo, [1], [ignore], [ignore])
AT_CHECK(cd checkout && MONOTONE --execute rename termite foo, [0], [ignore], [ignore])
AT_CHECK(cd checkout && test -e foo/termite -a ! -e termite -a -e gnat -a -d foo/gnat -a ! -e foo/gnat/gnat)

REN_CHECKOUT

## todo: 
# issues with missing files, should usually be allowed?
# rename to self
# rename root node

# rename to non-existing dir path: "foo->blweorih/o4thoihs" (this isn't a destdir case, but needs testing somewhere).

# file0->bar, file0 doesn't exist

# file0->bar, file0 exists, -e

# file0->bar, file0 doesn't exist, -e

# check that nothing happens if any would fail
# file0->bar file1->bar, file0 exists, file1 doesn't

# file0->bar file1->bar, file0 exists, file1 doesn't, -e

# file0->bar, bar/file0 exists in working, file0 doesn't -e

# file0->bar


AT_CLEANUP
