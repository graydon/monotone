#  -*- Autoconf -*-

AT_SETUP([importing files with non-english names])

MONOTONE_SETUP

EUROPEAN_UTF8=`printf "\xC3\xB6\xC3\xA4\xC3\xBc\xC3\x9F"`
EUROPEAN_8859_1=`printf "\xF6\xE4\xFC\xDF"`

JAPANESE_UTF8=`printf "\xE3\x81\xA6\xE3\x81\x99\xE3\x81\xA8"`
JAPANESE_EUC_JP=`printf "\xA4\xC6\xA4\xB9\xA4\xC8"`

if test "$OSTYPE" == "msys"; then
  FUNNY_FILENAME="file+name-with_funny@symbols%etc"
else
  FUNNY_FILENAME="file+name-with_funny@symbols%etc:"
fi

AT_CHECK(mkdir tmp)
AT_CHECK(touch "tmp/file name with spaces", [], [ignore], [ignore])
AT_CHECK(touch "tmp/$FUNNY_FILENAME", [], [ignore], [ignore])
AT_CHECK(touch "tmp/$EUROPEAN_UTF8", [], [ignore], [ignore])
AT_CHECK(touch "tmp/$JAPANESE_UTF8", [], [ignore], [ignore])
AT_CHECK(touch "tmp/$EUROPEAN_8859_1", [], [ignore], [ignore])
AT_CHECK(touch "tmp/$JAPANESE_EUC_JP", [], [ignore], [ignore])

AT_CHECK(MONOTONE add "tmp/file name with spaces", [], [ignore], [ignore])
AT_CHECK(MONOTONE add "tmp/$FUNNY_FILENAME", [], [ignore], [ignore])

# add some files with UTF8 names
export LANG=en_US.utf-8
export CHARSET=utf-8
AT_CHECK(MONOTONE add "tmp/$EUROPEAN_UTF8", [], [ignore], [ignore])
AT_CHECK(MONOTONE add "tmp/$JAPANESE_UTF8", [], [ignore], [ignore])

AT_CHECK(MONOTONE --branch=testbranch commit --message 'adding european and japanese names in UTF-8', [], [ignore], [ignore])

# check the names showed up in our manifest

AT_CHECK(MONOTONE cat manifest, [], [stdout])
AT_CHECK(mv stdout manifest)
AT_CHECK(grep funny manifest, [], [ignore], [ignore])
AT_CHECK(grep spaces manifest, [], [ignore], [ignore])
AT_CHECK(grep $JAPANESE_UTF8 manifest, [], [ignore], [ignore])
AT_CHECK(grep $EUROPEAN_UTF8 manifest, [], [ignore], [ignore])

# remove the UTF8 files, change locales, and add them again. both should work.

export LANG=de_DE.iso-8859-1
export CHARSET=iso-8859-1
AT_CHECK(MONOTONE drop "tmp/$EUROPEAN_8859_1", [], [ignore], [ignore])
AT_CHECK(MONOTONE add "tmp/$EUROPEAN_8859_1", [], [ignore], [ignore])

AT_CHECK(MONOTONE --branch=testbranch commit --message 'adding european name in ISO 8859-1', [], [ignore], [ignore])

export LANG=ja_JP.euc-jp
export CHARSET=euc-jp
AT_CHECK(MONOTONE drop "tmp/$JAPANESE_EUC_JP", [], [ignore], [ignore])
AT_CHECK(MONOTONE add "tmp/$JAPANESE_EUC_JP", [], [ignore], [ignore])

AT_CHECK(MONOTONE --branch=testbranch commit --message 'adding japanese name in EUC-JP', [], [ignore], [ignore])

# check the names showed up in our manifest

AT_CHECK(MONOTONE cat manifest, [], [stdout])
AT_CHECK(mv stdout manifest)
AT_CHECK(grep funny manifest, [], [ignore], [ignore])
AT_CHECK(grep spaces manifest, [], [ignore], [ignore])
AT_CHECK(grep $JAPANESE_UTF8 manifest, [], [ignore], [ignore])
AT_CHECK(grep $EUROPEAN_UTF8 manifest, [], [ignore], [ignore])

AT_CHECK(rm -Rf tmp)

AT_CLEANUP
